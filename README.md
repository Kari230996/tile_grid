# TileGrid — визуализация XYZ-тайлов (Web Mercator)

Мини-утилита на Python для демонстрации работы плиточной схемы карт (XYZ) и связи
между **географическими координатами** (широта/долгота, WGS84) и **картографическими**
координатами тайлов (**X/Y/Z**, Web Mercator, EPSG:3857).

> Подходит для ТЗ джуна: простая математика, аккуратная визуализация, понятные ответы на теорию.

---

## Возможности
- Перевод точки *(lat, lon, Z)* → тайл *(X, Y)* и пиксельная позиция *(px, py)* внутри тайла.
- Рендер сетки тайлов **N×N** вокруг точки, с подписями **X/Y/Z** и маркером точки.
- Настройка размера тайла (по умолчанию 256 px), z-уровней, размера сетки.
- Защитная валидация аргументов с понятными сообщениями об ошибках.

---

## Установка
Требуется Python 3.8+.
```bash
python -m venv .venv
# Windows
.venv\Scripts\activate
# macOS/Linux
# source .venv/bin/activate

pip install -r requirements.txt
```
Файл `requirements.txt`:
```
pillow>=10.0.0
```

---

## Запуск
Базовый пример (Точка в Самаре):
```bash
python tiles_demo.py --lat 53.1959 --lon 50.1008 --zooms 12 13 14 --grid 3 --out ./out
```
Пример вывода:
```
[OK] Z=12: сохранено ./out/grid_z12.png | tile=(2618,1330) px=(9,145)
[OK] Z=13: сохранено ./out/grid_z13.png | tile=(5236,2661) px=(18,34)
[OK] Z=14: сохранено ./out/grid_z14.png | tile=(10472,5322) px=(36,69)
```

Другие варианты:
```bash
# Крупнее тайл (512 px) на одном масштабе
python tiles_demo.py --lat 53.1959 --lon 50.1008 --zooms 14 --grid 3 --tile-size 512 --out ./out_bigtiles

# Таллинн, сетка 5×5 на Z=13
python tiles_demo.py --lat 59.437 --lon 24.7536 --zooms 13 --grid 5 --out ./out_tallinn
```

В результате получаются PNG с сеткой тайлов и меткой точки.
Нижняя подпись показывает служебную информацию: центр. тайл *(X, Y)* и пиксельные координаты точки *(px, py)* внутри него.

---

## Теория (готовые ответы для ТЗ)

### 1) Что такое географические и картографические координаты?
- **Географические координаты (WGS84):** широта φ (−90..+90°) и долгота λ (−180..+180°), не зависят от масштаба.
- **Картографические координаты (Web Mercator, XYZ):** мир делится на сетку **2^Z × 2^Z** тайлов при уровне **Z**,
  каждый тайл обычно **256×256 px**. Координаты тайла — целые индексы **X, Y**, зависящие от **Z**.

### 2) Преобразование (lat, lon, Z) → (X, Y) и (px, py)
Обозначим `n = 2^Z`, `φ` — в радианах.
```
x_norm = (λ + 180) / 360
y_norm = (1 - ln(tan φ + sec φ) / π) / 2

X = floor(x_norm * n)
Y = floor(y_norm * n)

px_total = x_norm * n * tile_size
py_total = y_norm * n * tile_size
px = floor(px_total) % tile_size
py = floor(py_total) % tile_size
```
Широта ограничивается диапазоном Web Mercator: примерно **±85.0511°**.

### 3) Почему при увеличении масштаба подгружаются новые тайлы?
При росте **Z** сетка становится плотнее (**2^Z × 2^Z**). Точка попадает уже в **другой набор тайлов** с большим
разрешением — клиент загружает **новые** плитки, а не «растягивает» старые: так сохраняется детализация.

### 4) Как понять границы тайла в градусах?
Для тайла *(X, Y, Z)*:
```
n = 2^Z
lon_min =  X    / n * 360 - 180
lon_max = (X+1) / n * 360 - 180

lat(y) = atan(sinh(π * (1 - 2*y/n))) в градусах
lat_max = lat(Y)
lat_min = lat(Y+1)
```

---

## Частые ошибки и их решения
- `ModuleNotFoundError: No module named 'PIL'` → установите `pip install pillow` в **том же venv**.
- `--grid` должно быть нечётным положительным числом (3, 5, …).
- Диапазоны: широта −90..90, долгота −180..180, Z — 0..22 (практически 0..19).
- Если линии текста обрезаются внизу, используйте больший `--tile-size` или меньший `--grid`.



